#!/user/bin/env python

from __future__ import with_statement

import sys, os
from PyQt4 import QtCore
from PyQt4 import QtGui

from skyqueryUI import Ui_MainWindow

from skyQuery import *
from gluon import *
from string import replace
import datetime

class DesignerMainWindow(QtGui.QMainWindow, Ui_MainWindow):
    def __init__(self,parent=None):
        super(DesignerMainWindow,self).__init__(parent)
        self.setupUi(self)
        
        QtCore.QObject.connect(self.pushButton,\
                               QtCore.SIGNAL("clicked()"),\
                               self.querySDSS)
        QtCore.QObject.connect(self.pushButton_3, 
                               QtCore.SIGNAL("clicked()"), \
                               self.saveData)
        QtCore.QObject.connect(self.radioButton, 
                               QtCore.SIGNAL('clicked(bool)'), 
                               self.radioButton_clicked)
        QtCore.QObject.connect(self.radioButton_2, 
                               QtCore.SIGNAL('clicked(bool)'), 
                               self.radioButton_clicked)
        self.myData = None
        self.squery = skyQuery()
        self.db = None
        self.dbOption = 'Other'
        self.lineEdit_4.setEchoMode(QtGui.QLineEdit.Password)
        try:
            os.mkdir('./skyQuery_cache')
        except:
            print 'Cache Folder exist'
                               
    def querySDSS(self):
        'Submite The Query for Sky Server'
        myquery =  unicode(self.plainTextEdit.toPlainText())
        
        tables = self.squery.dataQuery(myquery)
        self.textEdit.setHtml('')
        self.myData = None
        if(tables[0] == None):
            print tables[1]
            QtGui.QMessageBox.information(self, 'Data Problem', tables[1])
        else:
            html2 = '''<html><head>
        <title>SDSS Query Results</title>
        </head><body bgcolor=white>
        <div align=\'center\'>
        %s
        </div>
        </BODY></HTML>
        ''' %tables[0]
            self.textEdit.setHtml(html2)
            QtGui.QMessageBox.information(self, 'Data O.K.', 'Data recived see tab Data recived')
            self.myData = tables

    def saveData(self):
        if(self.myData != None):
            myListData = self.squery.dataExtraction(self.myData)
            self.tableModel(myListData)
        else:
             QtGui.QMessageBox.information(self, 'Data.', 'No data recived')
             
    def __tableModel(self, myListData):
        fields = myListData[0]
        if(self.dbOption == 'Other'):
            tmpDB = unicode(self.lineEdit_6.text())+'://'+\
                            unicode(self.lineEdit_3.text())+':'+\
                            unicode(self.lineEdit_4.text())+'@'+\
                            unicode(self.lineEdit_5.text())+'/'+\
                            replace(unicode(self.lineEdit_2.text()), ' ', '_')
                            
        elif(self.dbOption == 'SQLite'):
            tmpDB = 'sqlite://'+replace(unicode(self.lineEdit_2.text()), ' ', '_')
            
        tableName = unicode(self.lineEdit.text())
        tableName = replace(tableName, ' ', '_')
        defineTableFields = '\''+unicode(self.lineEdit.text())+'\''
        defineTableCode = """#!/usr/bin/env python
#*-* Coding : UTF-8 *-*
\'\'\' This Code was authomatic generated by SkyQuery program\'\'\'
from gluon import *
db =  DAL(\'%s\')
def tableDB(db):        
        """ %tmpDB
        
        for data in fields:
            defineTableFields +=',Field(\''+data+'\',type=\'double\')'
        
        tableModel = """
    db.define_table(%s)
        
        """ %defineTableFields
        
        defineTableCode = defineTableCode+tableModel+"""
def insertDataTable(db):
        """
                   
    
        
        for row in myListData[1:]:
            defineInsertFields = ''
            for i in range(len(row)):
                defineInsertFields += fields[i]+'='+str(row[i])+','
            insertDataTable = """
    db.%s.insert(%s)
    db.commit()
            
            """ %(tableName, defineInsertFields[:-1])
            defineTableCode = defineTableCode+insertDataTable
            
        endProg = """
tableDB(db)
insertDataTable(db)
        """
        defineTableCode = defineTableCode+endProg
        print defineTableCode 
        exec(defineTableCode)
            
    def tableModel(self, myListData):
        
        
    
        if(unicode(self.lineEdit.text()) != ''):
            if(unicode(self.lineEdit_2.text()) != ''):
                self.__tableModel(myListData)
            else:
                QtGui.QMessageBox.information(self, 'Table Name.', 'It is necessary define a name for the database')
        else:
            QtGui.QMessageBox.information(self, 'Table Name.', 'It is necessary define a name for the database table')
                
                
    def radioButton_clicked(self):
        radiobutton = self.sender()
        self.dbOption = radiobutton.text()
            
            
#    def dalConnect(self ): 
#        # create DAL connection (and create DB if not exists)
#        db=DAL('sqlite://guitest.sqlite',folder=None)
#    
#        # define a table 'person' (create/aster as necessary)
#        person = db.define_table('person',
#            Field('name','string', length=100),
#            Field('sex','string', length=1),
#            Field('active','boolean', comment="check!"),
#            Field('bio','text', comment="resume (CV)"),
#            )
#    
#        # set sample validator (do not allow empty nor duplicate names)
#        db.person.name.requires = [IS_NOT_EMPTY(), IS_NOT_IN_DB(db, 'person.name')]
#        db.person.sex.requires = IS_IN_SET({'M': 'Male', 'F': 'Female'})
#
#    
#        #>> create a testing view (Qt):
#        webView = self.webView
#        # webView.page() gives you the page
#        # webView.page().mainFrame() gives you the frame
#    
#        # create the web2py FORM based on person table
#        form = SQLFORM(db.person)
#    
#        # convert the web2py FORM to XML and display it
#        webView.setHtml(form.xml())

        
        
        
if __name__ == '__main__':
    app = QtGui.QApplication(sys.argv)
    dmw = DesignerMainWindow()
    dmw.show()
    sys.exit(app.exec_())
